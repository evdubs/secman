<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <title>Issue Asset</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/" style="color:white">Securities Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarScroll">
          <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
            <li class="nav-item">
              <a class="nav-link" href="/assets.html" style="color:white">Assets</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/categories.html" style="color:white">Categories</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users.html" style="color:white">Users</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container my-3">
      <h3>Issue Asset</h3>
    </div>
    <div class="container card w-75 text-bg-light">
      <div class="card-body">
        Issue an asset on the Liquid Network. If is_reissuable is true 
        then reissuance_amount and reissuance_address must be provided and 
        reissuance_address must be different from destination_address.
        Name, ticker, domain and pubkey are committed to the issuance
        transaction, thus they cannot be changed later.
        See <a href="https://docs.blockstream.com/liquid-securities/api-tutorial.html">
        the API tutorial</a> for more information on the Liquid Asset Registry.
      </div>
    </div>
    <div class="container my-3">
      <div class="btn-group" role="group" aria-label="Asset Actions">
        <button type="button" class="btn btn-primary" id="back-to-assets-button">Back to Assets</button>
      </div>
      <form class="my-3">
        <div class="mb-3">
          <label for="asset-name-input" class="form-label">Asset Name</label>
          <input type="text" class="form-control" id="asset-name-input" required></input>
          <div class="form-text">
            The name of the Asset as it will appear in Managed
            Assets. Length must be 5 to 255 ascii characters.
          </div>
        </div>
        <div class="mb-3">
          <label for="asset-amount-input" class="form-label">Asset Amount</label>
          <input type="number" class="form-control" id="asset-amount-input" required></input>
          <div class="form-text">
            The amount of the asset to issue. Refer to the precision
            field for how this is represented in the various Blockstream Liquid
            applications.
          </div>
        </div>
        <div class="mb-3">
          <label for="destination-address-input" class="form-label">Destination Address</label>
          <input type="text" class="form-control" id="destination-address-input" required></input>
          <div class="form-text">
            Must be a valid Liquid address generated by the treasury's
            Liquid node.
          </div>
        </div>
        <div class="mb-3">
          <label for="domain-input" class="form-label">Domain</label>
          <input type="text" class="form-control" id="domain-input" required></input>
          <div class="form-text">
            The domain that will be used to verify the asset if the
            asset is registered with the Liquid Asset Registry. Must be a valid
            domain name format, for example: example.com or sub.example.com. Do
            not include the http/s or www prefixes.
          </div>
        </div>
        <div class="mb-3">
          <label for="ticker-input" class="form-label">Ticker</label>
          <input type="text" class="form-control" id="ticker-input" required></input>
          <div class="form-text">
            The ticker you would like to assign to the asset if the
            asset is registered with the Liquid Asset Registry. Length must be 3
            to 24 characters. Valid characters are a to z, A to Z, 0 to 9, '.'
            and '-'.
          </div>
        </div>
        <div class="mb-3">
          <label for="precision-input" class="form-label">Precision</label>
          <input type="number" class="form-control" id="precision-input" value="0"></input>
          <div class="form-text">
            The precision that will be applied by apps that use the Liquid Asset
            Registry. To help explain how all the various apps show amounts
            using the precision, an amount of 10000 issued through Blockstream
            AMP API with a precision of 2 would show as:<br/>
            - 10000 through any Blockstream AMP API, which always shows
              amounts as undivisible and at sats level.<br/>
            - 100.00 on Blockstream Green Mobile, Blockstream Green Desktop,
              and Blockstream Explorer, all of which use the precision held in
              the registry.<br/>
            - 0.00010000 in elements-cli RPC commands, where BTC is the base
              unit.<br/><br/>
            Please note that when an asset is issued via Blockstream AMP with
            a reissuance token, the reissuance token is always seen in sats. So
            1 reissuance token will show in elements as 0.00000001. Precision is
            not taken into account when displaying reissuance token amounts in
            apps using the Liquid Asset Registry, which will always show amounts
            in sats.
          </div>
        </div>
        <div class="mb-3">
          <label for="public-key-input" class="form-label">Public Key</label>
          <input type="text" class="form-control" id="public-key-input" required></input>
          <div class="form-text">
            Pubkey for the Liquid Asset Registry, must be a compressed
            pubkey in hex. You can obtain the pubkey from an Elements address
            using the Elements getaddressinfo rpc command.
          </div>
        </div>
        <div class="col-12 mb-3">
          <div class="form-check">
            <label for="confidential-input" class="form-check-label">Confidential</label>
            <input type="checkbox" class="form-check-input" id="confidential-input" value=""></input>
            <div class="form-text">
              If true, the issuance amount will not be readable on the
              Liquid blockchain.
            </div>
          </div>
        </div>
        <div class="col-12 mb-3">
          <div class="form-check">
            <label for="transfer-restricted-input" class="form-check-label">Transfer Restricted</label>
            <input type="checkbox" class="form-check-input" id="transfer-restricted-input" value=""></input>
            <div class="form-text">
              If true, the asset can be transferred only between users
              registered by the issuer, with a Blockstream Green Managed Assets
              account associated to them.<br/>
              If false, the asset can be transferred only between Green Managed
              Assets accounts. This second option enforces weaker rules, as
              anyone could create a Green Managed Assets account, and then
              receive the asset.<br/>
              In both cases, the asset can also be received by or sent to the
              treasury wallet.
            </div>
          </div>
        </div>
        <div class="col-12 mb-3">
          <div class="form-check">
            <label for="reissuable-input" class="form-check-label">Reissuable</label>
            <input type="checkbox" class="form-check-input" id="reissuable-input" value=""></input>
            <div class="form-text">
              If true, the asset will be created as reissuable. If
              is_reissuable is true then reissuance_amount and reissuance_address
              must also be provided, and reissuance_address must be different from
              destination_address.
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label for="reissuance-amount-input" class="form-label">Reissuance Amount</label>
          <input type="number" class="form-control" id="reissuance-amount-input"></input>
          <div class="form-text">
            The amount of reissuance tokens to create if is_reissuable
            is set to True.<br/>
            Note that when an asset is issued via Blockstream AMP with a
            reissuance token, the reissuance token is always seen in sats. So 1
            reissuance token will show in elements as 0.00000001. Precision is
            not taken into account when displaying reissuance token amounts in
            apps using the Liquid Asset Registry.
          </div>
        </div>
        <div class="mb-3">
          <label for="reissuance-address-input" class="form-label">Reissuance Address</label>
          <input type="text" class="form-control" id="reissuance-address-input" required></input>
          <div class="form-text">
            The address that will receive the reissuance token if
            is_reissuable is set to True. If is_reissuable is False, this must
            either be an empty string or omitted.
          </div>
        </div>
        <div class="col-12">
          <button type="button" class="btn btn-primary" id="issue-button">Issue new asset</button>
        </div>      
      </form>
    </div>
  </body>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script>
    async function assets_issue() {
      const assetName = document.getElementById('asset-name-input').value ? 
        document.getElementById('asset-name-input').value : ''

      const assetAmount = document.getElementById('asset-amount-input').value ? 
        Number(document.getElementById('asset-amount-input').value) : 0

      const destinationAddress = document.getElementById('destination-address-input').value ? 
        document.getElementById('destination-address-input').value : ''

      const domain = document.getElementById('domain-input').value ?
        document.getElementById('domain-input').value : ''

      const ticker = document.getElementById('ticker-input').value ?
        document.getElementById('ticker-input').value : ''

      const precision = document.getElementById('precision-input').value ?
        Number(document.getElementById('precision-input').value) : 0
      
      const publicKey = document.getElementById('public-key-input').value ?
        document.getElementById('public-key-input').value : ''

      const confidential = document.getElementById('confidential-input').checked ?
        document.getElementById('confidential-input').checked : false

      const transferRestricted = document.getElementById('transfer-restricted-input').checked ?
        document.getElementById('transfer-restricted-input').checked : false

      const reissuable = document.getElementById('reissuable-input').checked ?
        document.getElementById('reissuable-input').checked : false

      const reissuanceAmount = document.getElementById('reissuance-amount-input').value ?
        Number(document.getElementById('reissuance-amount-input').value) : 0

      const reissuanceAddress = document.getElementById('reissuance-address-input').value ?
        document.getElementById('reissuance-address-input').value : ''

      console.debug(`
        assetName: ${assetName}
        assetAmount: ${assetAmount}
        destinationAddress: ${destinationAddress}
        domain: ${domain}
        ticker: ${ticker}
        precision: ${precision}
        publicKey: ${publicKey}
        confidential: ${confidential}
        transferRestricted: ${transferRestricted}
        reissuable: ${reissuable}
        reissuanceAmount: ${reissuanceAmount}
        reissuanceAddress: ${reissuanceAddress}
      `)

      const token = window.localStorage.getItem("token")

      const response = await fetch(new Request("/api/assets/issue", {
        method: "post",
        headers: { "Content-Type": "application/json", "Authorization": `token ${token}` },
        body: JSON.stringify({
          'name': assetName,
          'amount': assetAmount,
          'destination_address': destinationAddress,
          'domain': domain,
          'ticker': ticker,
          'precision': precision,
          'pubkey': publicKey,
          'is_confidential': confidential,
          'transfer_restricted': transferRestricted,
          'is_reissuable': reissuable,
          'reissuance_amount': reissuanceAmount,
          'reissuance_address': reissuanceAddress
        })
      }))

      console.info((await response.json()))

      document.getElementById('issue-button').removeAttribute('disabled')
    }

    var issueButton = document.getElementById('issue-button')
    issueButton.addEventListener('click', (event) => {
      issueButton.setAttribute('disabled', 'true')

      assets_issue()
    })

    document.getElementById('back-to-assets-button').addEventListener('click', (event) => {
      window.open("/assets.html", "_self")
    })
  </script>
</html>

