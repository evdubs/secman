<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <title>Asset Treasury Addresses</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="/" style="color:white">Securities Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarScroll">
          <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll" style="--bs-scroll-height: 100px;">
            <li class="nav-item">
              <a class="nav-link" href="/assets.html" style="color:white">Assets</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/categories.html" style="color:white">Categories</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/users.html" style="color:white">Users</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container my-3">
      <h3>Asset Treasury Addresses</h3>
    </div>
    <div class="container card w-75 text-bg-light">
      <div class="card-body">
        List all treasury addresses for the selected asset. 
        Users of Green Liquid Managed Assets accounts must send to one of
        these addresses to send the asset back to the treasury wallet.
      </div>
    </div>
    <div class="container my-3">
      <div class="btn-group" role="group" aria-label="Asset Actions">
        <button type="button" class="btn btn-primary" id="back-to-asset-button">Back to Asset</button>
      </div>
      <form class="my-3">
        <div class="mb-3">
          <label for="asset-uuid-input" class="form-label">Asset Uuid</label>
          <input type="text" class="form-control" id="asset-uuid-input" required></input>
        </div>
        <div class="mb-3">
          <label for="treasury-address-input" class="form-label">Treasury Address</label>
          <input type="text" class="form-control" id="treasury-address-input"></input>
        </div>
        <div class="btn-group" role="group" aria-label="Treasury Address Actions">
          <button type="button" class="btn btn-primary" id="list-button">List Treasury Addresses</button>
          <button type="button" class="btn btn-primary" id="add-button">Add Treasury Address</button>
          <button type="button" class="btn btn-primary" id="delete-button">Delete Treasury Address</button>
        </div>
      </form>
    </div>
    <div class="container my-3">
      <table class="table" id="treasury-address-table">
        <thead>
          <tr>
            <th scope="col">Treasury Address</th>
          </tr>
        </thead>
      </table>
    </div>
  </body>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script>
    async function asset_treasury_addresses() {
      const treasuryAddressTable = document.getElementById('treasury-address-table')
      for(i = 1; i < treasuryAddressTable.rows.length; i++) {
        treasuryAddressTable.deleteRow(i)
      }

      const uuid = document.getElementById('asset-uuid-input').value
      const token = window.localStorage.getItem("token")

      const response = await fetch(new Request(`/api/assets/${uuid}/treasury-addresses`, {
        method: "get",
        headers: { "Content-Type": "application/json", "Authorization": `token ${token}` }
      }))

      const treasuryAddresses = await response.json()

      for (const treasuryAddress of treasuryAddresses) {
        const row = treasuryAddressTable.insertRow()
        row.innerHTML = `<td>${treasuryAddress}</td>`
      }

      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
      const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

      document.getElementById('list-button').removeAttribute('disabled')
    }

    async function asset_treasury_addresses_add() {
      const uuid = document.getElementById('asset-uuid-input').value
      const token = window.localStorage.getItem("token")

      const response = await fetch(new Request(`/api/assets/${uuid}/treasury-addresses/add`, {
        method: "post",
        headers: { "Content-Type": "application/json", "Authorization": `token ${token}` },
        body: JSON.stringify([document.getElementById('treasury-address-input').value])
      }))

      asset_treasury_addresses()

      document.getElementById('add-button').removeAttribute('disabled')
    }

    async function asset_treasury_addresses_delete() {
      const uuid = document.getElementById('asset-uuid-input').value
      const token = window.localStorage.getItem("token")

      const response = await fetch(new Request(`/api/assets/${uuid}/treasury-addresses/delete`, {
        method: "delete",
        headers: { "Content-Type": "application/json", "Authorization": `token ${token}` },
        body: JSON.stringify([document.getElementById('treasury-address-input').value])
      }))

      asset_treasury_addresses()

      document.getElementById('delete-button').removeAttribute('disabled')
    }

    const params = new URLSearchParams(document.location.search)

    document.getElementById('asset-uuid-input').value = params.get("uuid")

    document.getElementById('back-to-asset-button').addEventListener('click', (event) => { 
      window.open(`/asset.html?uuid=${params.get("uuid")}`, "_self") 
    })

    var listButton = document.getElementById('list-button')
    listButton.addEventListener('click', (event) => {
      listButton.setAttribute('disabled', 'true')

      asset_treasury_addresses()
    })

    var addButton = document.getElementById('add-button')
    addButton.addEventListener('click', (event) => {
      addButton.setAttribute('disabled', 'true')

      asset_treasury_addresses_add()
    })

    var deleteButton = document.getElementById('delete-button')
    deleteButton.addEventListener('click', (event) => {
      deleteButton.setAttribute('disabled', 'true')

      asset_treasury_addresses_delete()
    })
  </script>
</html>